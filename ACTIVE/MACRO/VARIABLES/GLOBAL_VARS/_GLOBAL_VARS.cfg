#.................................................................................................................
# _GLOBAL_VARS - No additional options/ Usage: NONE
#    This macro holds all the global variables for this printer
#.................................................................................................................
# Required variable(s) to be set. Add the following to your global variable dictionary block as:
#
## ---NONE---
#
#.................................................................................................................
# Required external macro(s) used by this macro.
#
# _general_Debug
#
#.................................................................................................................

#.................................................................................................................
#
## URL Resources:
#
#.................................................................................................................

[gcode_macro _GLOBAL_VARS]
description: Helper: Contains global defined printer variables
variable_bedfanvars                              :                {}  ;bedfanvars gloabal variables
variable_fancheckvars                            :                {}  ;fan check global variables
variable_sb_vars                                 :                {}  ;sb_vars global variables
variable_wait_variable                           :                {}  ;wait_variable global variables
variable_state_fan_leds                          :   "'not_yet_set'"  ;current state of the fan leds
variable_state_logo_leds                         :   "'not_yet_set'"  ;current state of the logo leds
variable_state_bar_leds                          :   "'not_yet_set'"  ;current state of the bar leds
variable_state_nozzle_leds                       :   "'not_yet_set'"  ;current state of the nozzle leds
variable_current_state                           :                {}  ;current state of leds
variable_progressbar_enabled                     :                 0  ;progress bar is disabled at boot
variable_wait_count                              :               300  ;Total wait minutes is (duration * count) / 60 
variable_wait_duration                           :                 2  ;Total wait minutes is (duration * count) / 60 
variable_wait_waiting                            :             False  ;In a wait loop if true
variable_wait_ready                              :               200  ;temperature you want the extruder at the ready state
variable_wait_temp                               :               250  ;temperature you want the extruder to print at
variable_bedfanvars_flag                         :                 0  ;Bed heater reached target temp if this value > 0, Valid value: 0 (boot state), 2 (Target heater temp reached), 3 (chamber temp falling), 4 (chamber temp above defaultEnclosure temp)
variable_bedfanvars_lasttemp                     :               0.0  ;previous chamber temperature reading
variable_fancheckvars_part_cooling_fan_enabled   :                 0  ;Part cooling fan disabled = 0; Part cooling fan enaled=1
variable_pc_stop_count                           :                 0  ;number of times the part cooling fans has stopped rotating, if this count is greater than 3 the fan stoppage routine is called which pauses the printer
variable_he_stop_count                           :                 0  ;number of times the hot end cooling fans has stopped rotating, if this count is greater than 3 the fan stoppage routine is called which pauses the printer 
variable_start_idle_minutes                      :                 0  ;test_probe_accuracy - params - start_idle_minutes
variable_bed_temp                                :                 0  ;test_probe_accuracy - params - bed_temp
variable_extruder_temp                           :                 0  ;test_probe_accuracy - params - extruder_temp
variable_bed_soak_minutes                        :                 0  ;test_probe_accuracy - params - bed_soak_minutes
variable_extruder_soak_minutes                   :                 0  ;test_probe_accuracy - params - extruder_soak_minutes
variable_dwell_seconds                           :                 0  ;test_probe_accuracy - params - dwell_seconds
variable_dwell_lift_z                            :                 0  ;test_probe_accuracy - params - dwell_lift_z
variable_end_idle_minutes                        :                 0  ;test_probe_accuracy - params - end_idle_minutes
variable_state                                   :           'start'  ;test_probe_accuracy - params - state
variable_next_state                              :            'none'  ;test_probe_accuracy - params - next_state
variable_bucket_pos                              :                 1  ;Purge & Brush - Placeholder. The variable will later be set to contain, at random, a number representing the left or right bucket.      
variable_probe_attached                          :             False  ; global variable for Klicky Probe Macros - flag for attached probe
variable_probe_state                             :             False  ; global variable for Klicky Probe Macros - flag for the state of the Klicky probe
variable_probe_lock                              :             False  ; global variable for Klicky Probe Macros - flag for probe lock state
variable_z_endstop_x                             :                 0  ; global variable for Klicky Probe Macros - Klicky probe Z endstop X position
variable_z_endstop_y                             :                 0  ; global variable for Klicky Probe Macros - Klicky probe Z endstop Y position
variable_buffer                                  :                20  ; print surface bed mesh calibrate - boundary area for bed_mesh
variable_last_area_start_x                       :                -1  ; print surface bed mesh calibrate - bed_mesh start x value for last bed_mesh performed
variable_last_area_start_y                       :                -1  ; print surface bed mesh calibrate - bed_mesh start y value for last bed_mesh performed
variable_last_area_end_x                         :                -1  ; print surface bed mesh calibrate - bed_mesh end x value for last bed_mesh performed
variable_last_area_end_y                         :                -1  ; print surface bed mesh calibrate - bed_mesh end y value for last bed_mesh performed
variable_run                                     :             False  ;used internal to detect that the _GLOBAL_VARS was executed
gcode:
  _general_Debug msg="_GLOBAL_VARS - entering"
  ##########################################################################
  ##                     start of gloabl defines                          ##
  ## do not touch these variable they are used internally by other macros ##
  ##########################################################################
  ##### WAIT_VARIABLE SECTION #####
  {% set global_wait_variable_count                     = 300 %}
  {% set global_wait_variable_duration                  = 2 %}
  {% set global_wait_variable_waiting                   = False %}
  {% set global_wait_variable_ready                     = 200 %}
  {% set global_wait_variable_temp                      = 250 %}
  ##### End of WAIT_VARIABLE SECTION #####
  ##### SB_VARS SECTION #####
  {% set global_sb_vars_colors                          =   {
                                                              'white': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 1.0},
                                                              'standby': {'r': 0.01, 'g': 0.01, 'b': 0.01, 'w': 0.5},
                                                              'red': {'r': 1.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
                                                              'orange': {'r': 1.0, 'g': 0.25, 'b': 0.0, 'w': 0.0},
                                                              'yellow': {'r': 1.0, 'g': 1.0, 'b': 0.0, 'w': 0.0},
                                                              'green': {'r': 0.0, 'g': 1.0, 'b': 0.0, 'w': 0.0},
                                                              'blue': {'r': 0.0, 'g': 0.0, 'b': 1.0, 'w': 0.0},
                                                              'purple': {'r': 0.5, 'g': 0.0, 'b': 1.0, 'w': 0.0},
                                                              'pink': {'r': 1.0, 'g': 0.0, 'b': 0.5, 'w': 0.0},
                                                              'off': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.0},
                                                              'dimwhite': {'r': 0.0, 'g': 0.0, 'b': 0.0, 'w': 0.4}
                                                            }
  %}
  ##### End of SB_VARS SECTION #####
  ##### CURRENT STATE OF LEDS SECTION #####
  # need double qoutes or I get an error : Unable to parse 'set_fan_leds_rainbow' as a literal, etc
  {% set global_current_state_fan_leds                  = 'set_fan_leds_rainbow' %}
  {% set global_current_state_logo_leds                 = 'set_logo_leds_rainbow_barf' %}
  {% set global_current_state_bar_leds                  = 'set_bar_leds_progress' %}
  {% set global_current_state_nozzle_leds               = 'set_nozzle_leds_white' %}
  ##### End of CURRENT STATE OF LEDS SECTION #####
  ##### PROGRESSBAR ENABLED SECTION #####
  {% set global_progressbar_enabled                     =  0 %}  
  ##### End of PROGRESSBAR ENABLED SECTION #####
  ##### BEDFANVARS SECTION #####
  {% set global_bedfanvars_flag                         = 0 %}           ; Bed heater reached target temp if this value > 0, Valid value: 0 (boot state), 2 (Target heater temp reached), 3 (chamber temp falling), 4 (chamber temp above defaultEnclosure temp)
  {% set global_bedfanvars_lasttemp                     = 0.0 %}         ; previous chamber temperature reading
  ##### End of BEDFANVARS SECTION #####
  ##### FANCHECKVARS SECTION #####
  {% set global_fancheckvars_Part_Cooling_Fan_Enabled   = 0 %}           ; Part cooling fan disabled = 0; Part cooling fan enaled=1
  {% set global_pc_stop_count                           = 0 %}           ; number of times the part cooling fans has stopped rotating, if this count is greater than 3 the fan stoppage routine is called which pauses the printer
  {% set global_he_stop_count                           = 0 %}           ; number of times the hot end cooling fans has stopped rotating, if this count is greater than 3 the fan stoppage routine is called which pauses the printer 
  ##### End of FANCHECKVARS SECTION #####
  ##### TEST_PROBE_ACCURACY SECTION #####
  {% set global_tmacro_start_idle_minutes               = 0 %}           ;test_probe_accuracy - params - start_idle_minutes
  {% set global_tmacro_bed_temp                         = 0 %}           ;test_probe_accuracy - params - bed_temp
  {% set global_tmacro_extruder_temp                    = 0 %}           ;test_probe_accuracy - params - extruder_temp
  {% set global_tmacro_bed_soak_minutes                 = 0 %}           ;test_probe_accuracy - params - bed_soak_minutes
  {% set global_tmacro_extruder_soak_minutes            = 0 %}           ;test_probe_accuracy - params - extruder_soak_minutes
  {% set global_tmacro_dwell_seconds                    = 0 %}           ;test_probe_accuracy - params - dwell_seconds
  {% set global_tmacro_dwell_lift_z                     = 0 %}           ;test_probe_accuracy - params - dwell_lift_z
  {% set global_tmacro_end_idle_minutes                 = 0 %}           ;test_probe_accuracy - params - end_idle_minutes
  {% set global_tmacro_state                            = 'start' %}     ;test_probe_accuracy - params - state
  {% set global_tmacro_next_state                       = 'none' %}      ;test_probe_accuracy - params - next_state
  ##### End of TEST_PROBE_ACCURACY SECTION #####
  ##### KLICKY_PROBE_MACROS SECTION (_Probe_Variables) #####
  {% set global_probe_attached                          = False %}       ;global variable for Klicky Probe Macros - flag for attached probe
  {% set global_probe_state                             = False %}       ;global variable for Klicky Probe Macros - flag for the state of the Klicky probe
  {% set global_probe_lock                              = False %}       ;global variable for Klicky Probe Macros - flag for probe lock state
  {% set global_z_endstop_x                             = 0 %}           ;global variable for Klicky Probe Macros - Klicky probe Z endstop X position
  {% set global_z_endstop_y                             = 0 %}           ;global variable for Klicky Probe Macros - Klicky probe Z endstop Y position
  ##### End of KLICKY_PROBE_MACROS SECTION (_Probe_Variables) #####
  ##### BED_MESH_CALIBRATE SECTION #####
  {% set global_buffer                                  = 20 %}          ;print surface bed mesh calibrate - boundary area for bed_mesh
  {% set global_last_area_start_x                       = -1 %}          ;print surface bed mesh calibrate - bed_mesh start x value for last bed_mesh performed
  {% set global_last_area_start_y                       = -1 %}          ;print surface bed mesh calibrate - bed_mesh start y value for last bed_mesh performed
  {% set global_last_area_end_x                         = -1 %}          ;print surface bed mesh calibrate - bed_mesh end x value for last bed_mesh performed
  {% set global_last_area_end_y                         = -1 %}          ;print surface bed mesh calibrate - bed_mesh end y value for last bed_mesh performed
  
  ##### End of BED_MESH_CALIBRATE SECTION #####
  #####################################################################
  ##                      end of global defines                      ##
  #####################################################################

  # prepare dictonaries
  # {% set wait_variable_dic = {
                              # 'count'     : global_wait_variable_count,
                              # 'duration'  : global_wait_variable_duration,
                              # 'waiting'   : global_wait_variable_waiting,
                              # 'ready'     : global_wait_variable_ready,
                              # 'temp'      : global_wait_variable_temp
                             # }
  # %}
  # {% set bedfanvars_dic = {
                           # 'flag'          : global_bedfanvars_flag,
                           # 'lasttemp'      : global_bedfanvars_lasttemp
                          # }
  # %}
  # {% set fancheckvars_dic = {
                             # 'Part_Cooling_Fan_Enabled'  : global_fancheckvars_Part_Cooling_Fan_Enabled
                            # }
  # %}
  {% set sb_vars_dic = {
                        'colors'     : {
                                        'white'     : global_sb_vars_colors.white,
                                        'standby'   : global_sb_vars_colors.standby,
                                        'red'       : global_sb_vars_colors.red,
                                        'orange'    : global_sb_vars_colors.orange,
                                        'yellow'    : global_sb_vars_colors.yellow,
                                        'green'     : global_sb_vars_colors.green,
                                        'blue'      : global_sb_vars_colors.blue,
                                        'purple'    : global_sb_vars_colors.purple,
                                        'pink'      : global_sb_vars_colors.pink,
                                        'off'       : global_sb_vars_colors.off,
                                        'dimwhite'  : global_sb_vars_colors.dimwhite
                                       }
                       }
  %}
  # store results in variable
  #SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=bedfanvars                            VALUE="{bedfanvars_dic}"
  #SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=fancheckvars                          VALUE="{fancheckvars_dic}"
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=sb_vars                                 VALUE="{sb_vars_dic}"
  #SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=wait_variable                         VALUE="{wait_variable_dic}"
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=state_fan_leds                          VALUE="'{global_current_state_fan_leds}'"
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=state_logo_leds                         VALUE="'{global_current_state_logo_leds}'"
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=state_bar_leds                          VALUE="'{global_current_state_bar_leds}'"
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=state_nozzle_leds                       VALUE="'{global_current_state_nozzle_leds}'"
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=progressbar_enabled                     VALUE={global_progressbar_enabled}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=wait_count                              VALUE={global_wait_variable_count}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=wait_duration                           VALUE={global_wait_variable_duration}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=wait_waiting                            VALUE={global_wait_variable_waiting}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=wait_ready                              VALUE={global_wait_variable_ready}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=wait_temp                               VALUE={global_wait_variable_temp}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=bedfanvars_flag                         VALUE={global_bedfanvars_flag}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=bedfanvars_lasttemp                     VALUE={global_bedfanvars_lasttemp}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=fancheckvars_part_cooling_fan_enabled   VALUE={global_fancheckvars_Part_Cooling_Fan_Enabled}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=start_idle_minutes                      VALUE={global_tmacro_start_idle_minutes}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=bed_temp                                VALUE={global_tmacro_bed_temp}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=extruder_temp                           VALUE={global_tmacro_extruder_temp}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=bed_soak_minutes                        VALUE={global_tmacro_bed_soak_minutes}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=extruder_soak_minutes                   VALUE={global_tmacro_extruder_soak_minutes}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=dwell_seconds                           VALUE={global_tmacro_dwell_seconds}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=dwell_lift_z                            VALUE={global_tmacro_dwell_lift_z}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=end_idle_minutes                        VALUE={global_tmacro_end_idle_minutes}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=state                                   VALUE="'{global_tmacro_state}'"
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=next_state                              VALUE="'{global_tmacro_next_state}'"
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=probe_attached                          VALUE={global_probe_attached}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=probe_state                             VALUE={global_probe_state}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=probe_lock                              VALUE={global_probe_lock}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=z_endstop_x                             VALUE={global_z_endstop_x}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=z_endstop_y                             VALUE={global_z_endstop_y}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=pc_stop_count                           VALUE={global_pc_stop_count}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=he_stop_count                           VALUE={global_he_stop_count}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=buffer                                  VALUE={global_buffer}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=last_area_start_x                       VALUE={global_last_area_start_x}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=last_area_start_y                       VALUE={global_last_area_start_y}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=last_area_end_x                         VALUE={global_last_area_end_x}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=last_area_end_y                         VALUE={global_last_area_end_y}
  SET_GCODE_VARIABLE MACRO=_GLOBAL_VARS VARIABLE=run VALUE=True
  _general_Debug msg="_GLOBAL_VARS - exiting"