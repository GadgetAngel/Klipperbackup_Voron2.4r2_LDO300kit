#.................................................................................................................
# WAIT_Delayed - No additional options / Usage: NONE
#
# This macro is part of the WAITING_PREPRINT_NONBLOCKING macros.
# This is a non blocking wait to be used before printing starts (for example for use in heat soak).
# This macro display the amount of time left and check to see if the wait time has expired so that PRINT_START2 can be called
#
#.................................................................................................................
# Required variable(s) to be set. Add the following to your global variable dictionary block as:
#
# [gcode_macro _WAIT_Variable]
#  variablesd_count
#  variablesd_duration
#  variablesd_waiting
#
#.................................................................................................................
# Required external macro(s) used by this macro.
#
# _general_Debug
# _WAIT_Loop
# _PRINT_START2
# _WAIT_Variable
#.................................................................................................................

#.................................................................................................................
#
## URL: https://www.klipper3d.org/Command_Templates.html?h=variables#variables
#       https://github.com/rkolbi/voron2.4/blob/main/MY_V24-350/ACTIVE/MACRO-WAITING_PREPRINT_NONBLOCKING.cfg
##     
#.................................................................................................................

#.................................................................................................................
# My PRINT_START routine flows as follows: 
# PRINT_START.cfg:
#   if qglbeforesoakprint = true
#      G32 => Clears bed-mesh and performs G28, ATTACH_PROBE, QGL, DOCK_PROBE
#   else 
#	  G28
#	endif
#	_WAIT_Start MINUTES={SOAK}
#	
#_WAIT_Start.cfg:
#    WAIT_Delayed
#	PAUSE_BASE
#	
#PAUSE_BASE: captures the toolhead postion and pauses the print job.
#RESUME_BASE: moves the toolhead to the retrieved captured postion (stored by PAUSE_BASE) and reusmes the print job
#
#WAIT_Delayed.cfg:
#   if count > 0
#       _WAIT_Loop
#   if count == 0	
#       _PRINT_START2
#   endif
#   
#_PRINT_START2.cfg:
#    RESUME_BASE
#    G3201 -> Clears bed-mesh and performs G28, ATTACH_PROBE, QGL, DOCK_PROBE, CLEAN_NOZZLE, ATTACH_PROBE_LOCK, G28 Z, CALIBRATE_Z, applies bed-mesh, and DOCK_PROBE_UNLOCK
#.................................................................................................................

[delayed_gcode WAIT_Delayed]
gcode:
    _general_Debug msg="WAIT_Delayed- entering"
    {% set count = printer["gcode_macro _WAIT_Variable"].count|int %}
    {% set duration = printer["gcode_macro _WAIT_Variable"].duration|int %}
    M117 Pre-Print Heatsoaking... {((duration * count) / 60)|round(1)} minutes left.
    SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=count VALUE={count-1}
    {% if count > 0 %} _WAIT_Loop  {% endif %}
    {% if count == 0 %} 
        # FINAL ACION
        SET_GCODE_VARIABLE MACRO=_WAIT_Variable VARIABLE=waiting VALUE=False
        _PRINT_START2
    {% endif %}
    _general_Debug msg="WAIT_Delayed- exiting"
    